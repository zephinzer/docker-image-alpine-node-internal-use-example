sudo: required
language: bash
services:
  - docker
branches:
  only:
    - master
env:
  global:
    - BUILD_VERSION=$(./scripts/versioning/get-next -q)
    - DOCKER_REPO='zephinzer/alpine-node'
    - NEXT_ARGON='next_argon'
    - NEXT_BORON='next_boron'
    - NEXT_CARBON='next_carbon'
    - TAG_ARGON='argon'
    - TAG_BORON='boron'
    - TAG_CARBON='carbon'
    - DH_TAGS_URL=https://index.docker.io/v1/repositories/zephinzer/alpine-node/tags/
notifications:
  email:
    - dev@joeir.net
stages:
  - name: integrate
    if: branch = master
jobs:
  include:
    - stage: integrate
      script:
        - git remote remove origin
        - git remote add origin https://zephinzer:${GITHUB_TOKEN}@github.com/zephinzer/docker-image-alpine-node-internal-use-example.git
        - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
        - git fetch origin
        - git checkout master
        - git checkout public
        - CURRENT_HASH=$(git log -n 1 --pretty=format:"%H")
        - git remote add source https://zephinzer:${GITHUB_TOKEN}@github.com/zephinzer/docker-image-alpine-node.git
        - git fetch
        - git pull source master
        - UPDATED_HASH=$(git log -n 1 --pretty=format:"%H")
        - if [[ $UPDATED_HASH != $CURRENT_HASH ]]; then git push origin public; fi;
        - git remote remove source
        - CURRENT_DATE_STRING=$(date +'%Y%m%d%H%M%S')
        - git checkout -b hybrid_source_${CURRENT_DATE_STRING}
        - git rm --cached .travis.yml
        - git commit -m "Integrated branch public:${UPDATED_HASH} at $(date +'%Y-%m-%d %H:%M:%S')"
        - git checkout master
        - git merge hybrid_source
        - git push origin master
        - git branch -D hybrid_source_${CURRENT_DATE_STRING}